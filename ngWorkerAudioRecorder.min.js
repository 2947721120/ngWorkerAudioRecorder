/**
* ngWorkerAudioRecorder Module
*
* website http://www.weismarts.com
* author match08
* Description angular Audio Recorder Worker
*/
angular.module("ngWorkerAudioRecorder",["ngWorker"]).factory("wsMediaService",["$q",function(e){
// 获取
return self.init=function(){var t=e.defer();return window.AudioContext=window.AudioContext||window.webkitAudioContext,navigator.getUserMedia=navigator.getUserMedia=navigator.getUserMedia||navigator.webkitGetUserMedia||navigator.mozGetUserMedia||navigator.msGetUserMedia,window.URL=window.URL||window.webkitURL||window.mozURL||window.msURL,navigator.getUserMedia&&navigator.getUserMedia({audio:!0},function(e){new AudioContext;t.resolve(e)},function(e){console.warn("No live audio input in this browser!"),t.reject(e)}),t.promise},self}]).factory("AudioRecorderWorker",function(){return function(){function e(){d.initBuffers()}function t(e,t){for(var r=new Float32Array(t),n=0,o=0;o<e.length;o++)r.set(e[o],n),n+=e[o].length;return r}function r(e,t,r){for(var n=0;n<r.length;n++)e.setUint8(t+n,r.charCodeAt(n))}function n(e,t,r){for(var n=0;n<r.length;n++,t+=2){var o=Math.max(-1,Math.min(1,r[n]));e.setInt16(t,o<0?32768*o:32767*o,!0)}}function o(e,t){for(var r=e.length+t.length,n=new Float32Array(r),o=0,a=0;o<r;)n[o++]=e[a],n[o++]=t[a],a++;return n}function a(e){var t=new ArrayBuffer(44+2*e.length),o=new DataView(t);/* RIFF identifier */
/* file length */
/* RIFF type */
/* format chunk identifier */
/* format chunk length */
/* sample format (raw) */
/* channel count */
/* sample rate */
/* byte rate (sample rate * block align) */
/* block align (channel count * bytes per sample) */
/* bits per sample */
/* data chunk identifier */
/* data chunk length */
return r(o,0,"RIFF"),o.setUint32(4,32+2*e.length,!0),r(o,8,"WAVE"),r(o,12,"fmt "),o.setUint32(16,16,!0),o.setUint16(20,1,!0),o.setUint16(22,2,!0),o.setUint32(24,m,!0),o.setUint32(28,4*m,!0),o.setUint16(32,4,!0),o.setUint16(34,16,!0),r(o,36,"data"),o.setUint32(40,2*e.length,!0),n(o,44,e),o}function i(t){m=t.sampleRate,outputBufferLength=t.outputBufferLength,h=t.outputSampleRate||h,g=t.numChannels||g,p=t.mimeType||p,t.recordBufferService?d.init(t):(d={},d.buffersLength=0,d.buffers=[],d.initBuffers=function(){for(var e=0;e<g;e++)d.buffers[e]=[]},d.record=function(e){for(var t=0;t<g;t++)d.buffers[t].push(e[t]);d.buffersLength+=e[0].length},d.clear=function(){d.buffersLength=0,d.buffers=[]}),e()}function s(e){d.record(e)}function u(){d.clear(),e()}function c(){for(var e=[],r=0;r<g;r++)e.push(t(d.buffers[r],d.buffersLength));this.postMessage({command:"getBuffer",data:e})}function f(e){for(var r=[],n=0;n<g;n++)r.push(t(d.buffers[n],d.buffersLength));var i;i=2===g?o(r[0],r[1]):r[0];var s=a(i),u=new Blob([s],{type:e});this.postMessage({command:"exportWAV",data:u})}var d,h=16e3,m=16e3,g=2,p="audio/wav";this.onmessage=function(e){switch(e.data.command){case"init":i(e.data.config);break;case"record":s(e.data.buffer);break;case"clear":u();break;case"getBuffer":c();break;case"exportWAV":f(e.data.type)}}}}).factory("wsAudioRecorder",["wsWorker","AudioRecorderWorker",function(e,t){var r=function(r,n){this.consumers=[];var o=n||{},a=o.errorCallback||function(){},i=o.inputBufferLength||4096,s=o.outputBufferLength||4e3,u=o.numChannels||2,c=o.mimeType||"audio/wav",f={getBuffer:[],exportWAV:[]};this.context=r.context,this.node=this.context.createScriptProcessor(i),e.$new("audioRecorderWorker",o.worker||t);2*this.context.sampleRate;e.postMessage("audioRecorderWorker",{command:"init",config:{sampleRate:this.context.sampleRate,outputBufferLength:s,outputSampleRate:o.outputSampleRate||16e3}});var d=!1;this.node.onaudioprocess=function(t){if(d){for(var r=[],n=0;n<u;n++)r.push(t.inputBuffer.getChannelData(n));e.postMessage("audioRecorderWorker",{command:"record",buffer:r})}},this.start=function(t){return this.consumers.forEach(function(r,n,o){return e.postMessage(r,{command:"start",data:t}),d=!0,!0}),d=!0,this.consumers.length>0},this.stop=function(){d&&(this.consumers.forEach(function(t,r,n){e.postMessage(t,{command:"stop"})}),d=!1)},this.cancel=function(){this.stop(),e.postMessage("audioRecorderWorker",{command:"clear"})},this.getBuffer=function(t){f.getBuffer.push(t),e.postMessage("audioRecorderWorker",{command:"getBuffer"})},this.exportWAV=function(t,r){f.exportWAV.push(t),e.postMessage("audioRecorderWorker",{command:"exportWAV",type:c})},this.forceDownload=function(e,t){if(!e)return!1;var r=window.URL.createObjectURL(e),n=window.document.createElement("a");n.href=r,n.download=t||"output.wav";var o=document.createEvent("Event");return o.initEvent("click",!0,!0),n.dispatchEvent(o),!0},myClosure=this,e.onMessage("audioRecorderWorker",function(t){switch(t.data.error&&"silent"==t.data.error&&a("silent"),t.data.command){case"newBuffer":myClosure.consumers.forEach(function(r,n,o){e.postMessage(r,{command:"process",data:t.data.data})});break;case"getBuffer":var r=f[t.data.command].pop();r(t.data.data);break;case"exportWAV":var r=f[t.data.command].pop();r(t.data.data)}}),r.connect(this.node),this.node.connect(this.context.destination)},n={};
//创建一个新的
return n.$new=function(e,t){var n=window.AudioContext,o=new n,a=o.createMediaStreamSource(e);return window.firefox_audio_hack=a,new r(a,t)},n}]);